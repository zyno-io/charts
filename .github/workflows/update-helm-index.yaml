name: Update Helm Index

on:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  update-index:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.4

      - name: Download release assets
        id: download
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          mkdir -p /tmp/charts
          gh release download "${{ github.event.release.tag_name }}" \
            --repo "${{ github.repository }}" \
            --pattern "*.tgz" \
            --dir /tmp/charts || true

          TGZ_COUNT=$(find /tmp/charts -name "*.tgz" | wc -l)
          echo "tgz_count=$TGZ_COUNT" >> "$GITHUB_OUTPUT"
          if [ "$TGZ_COUNT" -eq 0 ]; then
            echo "Error: No .tgz assets found in release ${{ github.event.release.tag_name }}. Failing."
            exit 1
          fi
          echo "Downloaded $TGZ_COUNT .tgz file(s)."

      - name: Normalize chart packages
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          for TGZ_PATH in /tmp/charts/*.tgz; do
            if helm show chart "$TGZ_PATH" > /dev/null 2>&1; then
              echo "Chart $(basename "$TGZ_PATH") is properly packaged."
              continue
            fi
            echo "Chart $(basename "$TGZ_PATH") requires normalization (e.g. macOS-packaged archive)."
            CHART_YAML=$(tar -xzOf "$TGZ_PATH" ./Chart.yaml 2>/dev/null) || true
            CHART_NAME=$(echo "$CHART_YAML" | grep "^name:" | awk '{print $2}')
            CHART_VER=$(echo "$CHART_YAML" | grep "^version:" | awk '{print $2}')
            if [ -z "$CHART_NAME" ] || [ -z "$CHART_VER" ]; then
              echo "Error: Cannot determine chart metadata from $(basename "$TGZ_PATH"). The .tgz may be corrupted."
              exit 1
            fi
            echo "Re-packaging: chart=$CHART_NAME version=$CHART_VER"
            NORM_TMPDIR=$(mktemp -d)
            CHART_DIR="$NORM_TMPDIR/$CHART_NAME"
            mkdir "$CHART_DIR"
            tar -xzf "$TGZ_PATH" \
              --exclude='._*' \
              --exclude='.DS_Store' \
              --strip-components=1 \
              -C "$CHART_DIR"
            NEW_TGZ="$NORM_TMPDIR/${CHART_NAME}-${CHART_VER}.tgz"
            tar -czf "$NEW_TGZ" -C "$NORM_TMPDIR" "$CHART_NAME"
            NORMALIZED_PATH="/tmp/charts/${CHART_NAME}-${CHART_VER}.tgz"
            mv "$NEW_TGZ" "$NORMALIZED_PATH"
            # Remove original only if it had a different name (mv already overwrites same-path files)
            [ "$TGZ_PATH" != "$NORMALIZED_PATH" ] && rm -f "$TGZ_PATH"
            gh release upload "${{ github.event.release.tag_name }}" \
              "$NORMALIZED_PATH" \
              --repo "${{ github.repository }}" \
              --clobber
            echo "Re-packaged and re-uploaded $(basename "$NORMALIZED_PATH") to release."
            rm -rf "$NORM_TMPDIR"
          done

      - name: Regenerate Helm index
        run: |
          MERGE_FLAG=""
          if [ -f ./index.yaml ]; then
            MERGE_FLAG="--merge ./index.yaml"
          fi
          helm repo index /tmp/charts \
            --url "https://github.com/${{ github.repository }}/releases/download/${{ github.event.release.tag_name }}" \
            $MERGE_FLAG
          cp /tmp/charts/index.yaml ./index.yaml

      - name: Verify new version in index.yaml
        run: |
          FAILED=0
          for TGZ in /tmp/charts/*.tgz; do
            CHART_VERSION=$(helm show chart "$TGZ" 2>/dev/null | grep "^version:" | awk '{print $2}')
            if [ -z "$CHART_VERSION" ]; then
              echo "Error: Could not read chart version from $(basename "$TGZ") after normalization."
              FAILED=1
              continue
            fi
            echo "Checking for chart version: $CHART_VERSION"
            VERSION_ESCAPED=$(printf '%s' "$CHART_VERSION" | sed 's/[.+]/\\&/g')
            if ! grep -qE "^[[:space:]]+version: ${VERSION_ESCAPED}$" ./index.yaml; then
              echo "Error: Version $CHART_VERSION from $(basename "$TGZ") not found in index.yaml after regeneration."
              FAILED=1
            else
              echo "Version $CHART_VERSION found in index.yaml."
            fi
          done
          if [ "$FAILED" -ne 0 ]; then
            exit 1
          fi

      - name: Commit updated index.yaml
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add index.yaml
          if git diff --staged --quiet; then
            echo "No changes to index.yaml"
          else
            git commit -m "Update Helm index for release ${{ github.event.release.tag_name }}"
            git push
          fi
