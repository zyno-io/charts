name: Update Helm Index

on:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  update-index:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.4

      - name: Download release assets
        id: download
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          mkdir -p /tmp/charts
          gh release download "${{ github.event.release.tag_name }}" \
            --repo "${{ github.repository }}" \
            --pattern "*.tgz" \
            --dir /tmp/charts || true

          TGZ_COUNT=$(find /tmp/charts -name "*.tgz" | wc -l)
          echo "tgz_count=$TGZ_COUNT" >> "$GITHUB_OUTPUT"
          if [ "$TGZ_COUNT" -eq 0 ]; then
            echo "Error: No .tgz assets found in release ${{ github.event.release.tag_name }}. Failing."
            exit 1
          fi
          echo "Downloaded $TGZ_COUNT .tgz file(s)."

      - name: Normalize chart packages
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          for TGZ_PATH in /tmp/charts/*.tgz; do
            if helm show chart "$TGZ_PATH" > /dev/null 2>&1; then
              echo "Chart $(basename "$TGZ_PATH") is properly packaged."
              continue
            fi
            echo "Chart $(basename "$TGZ_PATH") requires normalization (e.g. macOS-packaged archive)."
            CHART_YAML=$(tar -xzOf "$TGZ_PATH" ./Chart.yaml 2>/dev/null) || true
            CHART_NAME=$(echo "$CHART_YAML" | grep "^name:" | awk '{print $2}')
            CHART_VER=$(echo "$CHART_YAML" | grep "^version:" | awk '{print $2}')
            if [ -z "$CHART_NAME" ] || [ -z "$CHART_VER" ]; then
              echo "Error: Cannot determine chart metadata from $(basename "$TGZ_PATH"). The .tgz may be corrupted."
              exit 1
            fi
            echo "Re-packaging: chart=$CHART_NAME version=$CHART_VER"
            NORM_TMPDIR=$(mktemp -d)
            CHART_DIR="$NORM_TMPDIR/$CHART_NAME"
            mkdir "$CHART_DIR"
            tar -xzf "$TGZ_PATH" \
              --exclude='._*' \
              --exclude='.DS_Store' \
              --strip-components=1 \
              -C "$CHART_DIR"
            NEW_TGZ="$NORM_TMPDIR/${CHART_NAME}-${CHART_VER}.tgz"
            tar -czf "$NEW_TGZ" -C "$NORM_TMPDIR" "$CHART_NAME"
            NORMALIZED_PATH="/tmp/charts/${CHART_NAME}-${CHART_VER}.tgz"
            mv "$NEW_TGZ" "$NORMALIZED_PATH"
            # Remove original only if it had a different name (mv already overwrites same-path files)
            [ "$TGZ_PATH" != "$NORMALIZED_PATH" ] && rm -f "$TGZ_PATH"
            gh release upload "${{ github.event.release.tag_name }}" \
              "$NORMALIZED_PATH" \
              --repo "${{ github.repository }}" \
              --clobber
            echo "Re-packaged and re-uploaded $(basename "$NORMALIZED_PATH") to release."
            rm -rf "$NORM_TMPDIR"
          done

      - name: Install yq
        uses: mikefarah/yq@5a7e72a743649b1b3a47d1a1d8214f3453173c51 # v4.52.4

      - name: Regenerate Helm index
        run: |
          helm repo index /tmp/charts \
            --url "https://github.com/${{ github.repository }}/releases/download/${{ github.event.release.tag_name }}"

          if [ -f ./index.yaml ]; then
            # Merge new entries into existing index using yq instead of
            # helm's --merge flag, which uses SemVer comparison and treats
            # versions differing only in build metadata (e.g. 0.1.0+3 vs
            # 0.1.0+4) as identical, silently dropping entries.
            OLD_INDEX_PATH="./index.yaml" NEW_INDEX_PATH="/tmp/charts/index.yaml" yq -n '
              (load(strenv(OLD_INDEX_PATH))) as $old |
              (load(strenv(NEW_INDEX_PATH))) as $new |
              {"apiVersion": "v1", "entries": {}, "generated": ""} |
              .apiVersion = ($new.apiVersion // $old.apiVersion // .apiVersion) |
              .generated = ($new.generated // $old.generated // .generated) |
              .entries = (($old.entries // {}) *+ ($new.entries // {})) |
              .entries |= with_entries(.value |= (unique_by(.version) | sort_by(.created) | reverse))
            ' > /tmp/charts/index.merged.yaml
            cp /tmp/charts/index.merged.yaml ./index.yaml
          else
            cp /tmp/charts/index.yaml ./index.yaml
          fi

      - name: Verify new version in index.yaml
        run: |
          FAILED=0
          for TGZ in /tmp/charts/*.tgz; do
            CHART_INFO=$(helm show chart "$TGZ" 2>/dev/null)
            CHART_NAME=$(echo "$CHART_INFO" | grep "^name:" | awk '{print $2}')
            CHART_VERSION=$(echo "$CHART_INFO" | grep "^version:" | awk '{print $2}')
            if [ -z "$CHART_NAME" ] || [ -z "$CHART_VERSION" ]; then
              echo "Error: Could not read chart metadata from $(basename "$TGZ") after normalization."
              FAILED=1
              continue
            fi
            echo "Checking for chart=$CHART_NAME version=$CHART_VERSION"
            FOUND=$(CHART_NAME="$CHART_NAME" CHART_VERSION="$CHART_VERSION" \
              yq '.entries[strenv(CHART_NAME)][] | select(.version == strenv(CHART_VERSION)) | .version' \
              ./index.yaml)
            if [ -z "$FOUND" ]; then
              echo "Error: Version $CHART_VERSION from $(basename "$TGZ") not found in index.yaml after regeneration."
              FAILED=1
            else
              echo "Version $CHART_VERSION found in index.yaml."
            fi
          done
          if [ "$FAILED" -ne 0 ]; then
            exit 1
          fi

      - name: Commit updated index.yaml
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add index.yaml
          if git diff --staged --quiet; then
            echo "No changes to index.yaml"
          else
            git commit -m "Update Helm index for release ${{ github.event.release.tag_name }}"
            git push
          fi
