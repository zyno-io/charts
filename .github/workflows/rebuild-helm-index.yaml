name: Rebuild Helm Index

on:
  workflow_dispatch:
    inputs:
      release_limit:
        description: Maximum number of releases to inspect (newest first)
        required: false
        default: "200"

permissions:
  contents: write

jobs:
  rebuild-index:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.4

      - name: Install yq
        uses: mikefarah/yq@5a7e72a743649b1b3a47d1a1d8214f3453173c51 # v4.52.4

      - name: Add missing releases to index.yaml
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Collect the release tag names that are already referenced in index.yaml.
          # URL format in the index:
          #   https://github.com/OWNER/REPO/releases/download/<TAG>/<file>.tgz
          INDEXED_TAGS=$(grep -oE 'releases/download/[^/]+' index.yaml \
            | awk -F'/' '{print $3}' | sed 's/%2B/+/g' | sort -u || true)

          # Iterate over every release tag in the repository (newest first).
          while IFS= read -r TAG; do
            if echo "$INDEXED_TAGS" | grep -qxF "$TAG"; then
              echo "Release $TAG already in index.yaml — skipping."
              continue
            fi

            echo "Release $TAG missing from index.yaml — processing."

            RELEASE_DIR=$(mktemp -d)

            # Download all .tgz assets attached to this release.
            gh release download "$TAG" \
              --repo "${{ github.repository }}" \
              --pattern "*.tgz" \
              --dir "$RELEASE_DIR" || true

            if ! ls "$RELEASE_DIR"/*.tgz > /dev/null 2>&1; then
              echo "No .tgz assets found for release $TAG — skipping."
              rm -rf "$RELEASE_DIR"
              continue
            fi

            # Normalize any macOS-packaged archives so Helm can read them.
            for TGZ_PATH in "$RELEASE_DIR"/*.tgz; do
              [ -f "$TGZ_PATH" ] || continue
              if helm show chart "$TGZ_PATH" > /dev/null 2>&1; then
                echo "  $(basename "$TGZ_PATH") is properly packaged."
                continue
              fi
              echo "  $(basename "$TGZ_PATH") requires normalization."
              CHART_YAML=$(tar -xzOf "$TGZ_PATH" ./Chart.yaml) || true
              CHART_NAME=$(echo "$CHART_YAML" | grep "^name:" | awk '{print $2}')
              CHART_VER=$(echo "$CHART_YAML"  | grep "^version:" | awk '{print $2}')
              if [ -z "$CHART_NAME" ] || [ -z "$CHART_VER" ]; then
                echo "  Error: Cannot determine chart metadata from $(basename "$TGZ_PATH"). Skipping."
                continue
              fi
              NORM_TMPDIR=$(mktemp -d)
              CHART_DIR="$NORM_TMPDIR/$CHART_NAME"
              mkdir "$CHART_DIR"
              tar -xzf "$TGZ_PATH" \
                --exclude='._*' \
                --exclude='.DS_Store' \
                --strip-components=1 \
                -C "$CHART_DIR"
              NEW_TGZ="$NORM_TMPDIR/${CHART_NAME}-${CHART_VER}.tgz"
              tar -czf "$NEW_TGZ" -C "$NORM_TMPDIR" "$CHART_NAME"
              NORMALIZED_PATH="$RELEASE_DIR/${CHART_NAME}-${CHART_VER}.tgz"
              mv "$NEW_TGZ" "$NORMALIZED_PATH"
              [ "$TGZ_PATH" != "$NORMALIZED_PATH" ] && rm -f "$TGZ_PATH"
              rm -rf "$NORM_TMPDIR"
            done

            # Build a per-release index with the correct download URL.
            helm repo index "$RELEASE_DIR" \
              --url "https://github.com/${{ github.repository }}/releases/download/$TAG"

            # Helm sets "created" from the .tgz mtime (i.e. download time).
            # Overwrite with the actual release timestamp.
            RELEASE_CREATED=$(gh release view "$TAG" \
              --repo "${{ github.repository }}" \
              --json createdAt --jq '.createdAt')
            RELEASE_CREATED="$RELEASE_CREATED" \
              yq -i '.entries[][].created = strenv(RELEASE_CREATED)' "$RELEASE_DIR/index.yaml"

            # Merge new entries into index.yaml using yq instead of
            # helm's --merge flag, which uses SemVer comparison and treats
            # versions differing only in build metadata (e.g. 0.1.0+3 vs
            # 0.1.0+4) as identical, silently dropping entries.
            if [ -f ./index.yaml ]; then
              OLD_INDEX_PATH="./index.yaml" NEW_INDEX_PATH="$RELEASE_DIR/index.yaml" yq -n '
                (load(strenv(OLD_INDEX_PATH))) as $old |
                (load(strenv(NEW_INDEX_PATH))) as $new |
                {"apiVersion": "v1", "entries": {}, "generated": ""} |
                .apiVersion = ($new.apiVersion // $old.apiVersion // .apiVersion) |
                .generated = ($new.generated // $old.generated // .generated) |
                .entries = (($old.entries // {}) *+ ($new.entries // {})) |
                .entries |= with_entries(.value |= (unique_by(.version) | sort_by(.created) | reverse))
              ' > "$RELEASE_DIR/index.merged.yaml"
              mv "$RELEASE_DIR/index.merged.yaml" ./index.yaml
            else
              cp "$RELEASE_DIR/index.yaml" ./index.yaml
            fi

            rm -rf "$RELEASE_DIR"
            echo "  Added $TAG to index.yaml."
          done < <(gh release list --repo "${{ github.repository }}" --limit "${{ inputs.release_limit || 200 }}" --json tagName --jq '.[].tagName')

      - name: Commit updated index.yaml
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add index.yaml
          if git diff --staged --quiet; then
            echo "index.yaml is already up-to-date — nothing to commit."
          else
            git commit -m "Rebuild Helm index: add missing release entries"
            git push
          fi
